---
phase: 04-test-coverage
plan: 05
type: execute
wave: 2
depends_on: ["04-01", "04-02", "04-03", "04-04"]
files_modified:
  - package.json
  - .coverage/
  - src/ui/formatters.test.ts
  - src/types/branded.test.ts
autonomous: true
requirements:
  - TEST-05
must_haves:
  truths:
    - 整体测试覆盖率 >= 80%
    - 低覆盖率模块得到补充测试
    - 覆盖率报告可查看
  artifacts:
    - path: "src/ui/formatters.test.ts"
      provides: "UI 格式化函数测试"
      min_coverage: 80
    - path: "src/types/branded.test.ts"
      provides: "Branded 类型测试"
      min_coverage: 80
    - path: ".coverage/index.html"
      provides: "HTML 覆盖率报告"
  key_links:
    - from: "coverage report"
      to: "all source files"
      via: "bun test --coverage"
---

<objective>
完成剩余的测试补充工作，确保整体覆盖率达到 80%+，并生成可查看的覆盖率报告。

Purpose: 达成 Phase 4 的最终目标
Output: 补充测试和覆盖率报告，整体覆盖率 >= 80%
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-test-coverage/04-CONTEXT.md

## 当前低覆盖率模块 (来自覆盖率报告)

- src/effect/services/cardService.ts: 9.09% → 目标 80%
- src/effect/services/priorityService.ts: 40.00% → 目标 80%
- src/effect/test-helpers.ts: 25.00% → 目标 80%
- src/ui/formatters.ts: 7.69% → 目标 80%
- src/types/branded.ts: 0.00% → 目标 80%
- src/game/phases.ts: 60.87% → 目标 70%

## 当前高覆盖率模块 (保持)

- src/game/resolution/: 100%
- src/game/moves.ts: 96.43%
- src/game/assertions.ts: 88.89%
- src/utils.ts: 100%
</context>

<tasks>

<task type="auto">
  <name>Task 1: 添加 UI Formatters 测试</name>
  <files>src/ui/formatters.test.ts</files>
  <action>
    创建 src/ui/formatters.test.ts，测试 UI 格式化函数：

    1. **卡牌名称格式化**:
       - formatCardName - 格式化卡牌显示名称
       - 中英文名称支持
       - 未知卡牌类型处理

    2. **玩家状态格式化**:
       - formatPlayerStatus - 格式化玩家状态文本
       - 存活/死亡/囚禁状态

    3. **消息格式化**:
       - formatMessage - 格式化聊天消息
       - 不同类型的消息样式

    4. **时间格式化**:
       - formatDuration - 格式化持续时间
       - formatTimeLeft - 格式化剩余时间

    5. **边界情况**:
       - 无效输入处理
       - 空值处理
       - 默认值测试

    参考 src/ui/formatters.ts 导出函数。
  </action>
  <verify>
    bun test src/ui/formatters.test.ts --coverage 2>&1 | tail -20
  </verify>
  <done>
    formatters.test.ts 存在且测试通过，formatters.ts 覆盖率 >= 80%
  </done>
</task>

<task type="auto">
  <name>Task 2: 添加 Branded Types 测试</name>
  <files>src/types/branded.test.ts</files>
  <action>
    创建 src/types/branded.test.ts，测试 Branded 类型：

    1. **PlayerId 品牌类型**:
       - 创建合法的 PlayerId
       - 验证品牌标记
       - 类型转换测试

    2. **CardId 品牌类型**:
       - 创建合法的 CardId
       - 验证品牌标记

    3. **GameId 品牌类型**:
       - 创建合法的 GameId
       - 验证品牌标记

    4. **验证函数**:
       - isPlayerId - 验证 PlayerId
       - isCardId - 验证 CardId
       - isGameId - 验证 GameId
       - 无效值应返回 false

    5. **工厂函数**:
       - makePlayerId - 创建 PlayerId
       - makeCardId - 创建 CardId
       - makeGameId - 创建 GameId

    Branded 类型用于编译时的类型安全，
    测试主要验证创建和验证函数。
  </action>
  <verify>
    bun test src/types/branded.test.ts --coverage 2>&1 | tail -20
  </verify>
  <done>
    branded.test.ts 存在且测试通过，branded.ts 覆盖率 >= 80%
  </done>
</task>

<task type="auto">
  <name>Task 3: 生成并验证最终覆盖率报告</name>
  <files></files>
  <action>
    生成最终的覆盖率报告并验证达标：

    1. 运行完整测试套件：
       ```bash
       bun test --coverage > .coverage/report.txt 2>&1
       ```

    2. 解析覆盖率报告，提取关键指标：
       - 整体语句覆盖率
       - 整体分支覆盖率
       - 各模块覆盖率

    3. 验证覆盖率目标：
       - 整体覆盖率 >= 80%
       - 核心模块 (resolution, services) >= 80%
       - 新添加的测试文件通过

    4. 如果覆盖率未达标：
       - 识别剩余的低覆盖率模块
       - 为未覆盖的代码路径添加测试
       - 优先覆盖关键业务逻辑

    5. 生成摘要报告：
       - 测试总数
       - 覆盖率百分比
       - 达标/未达标模块列表
       - 改进建议

    注意：如果 bun test --coverage 无法生成 HTML 报告，
    至少确保文本报告完整且可阅读。
  </action>
  <verify>
    bun test --coverage 2>&1 | grep -E "(Coverage|Stmts|Branch|Funcs|Lines)" | tail -5
    # 验证整体覆盖率 >= 80%
  </verify>
  <done>
    整体测试覆盖率 >= 80%，所有关键模块达标
  </done>
</task>

</tasks>

<verification>
1. 运行 `bun test` 所有测试通过
2. 运行 `bun test --coverage` 验证整体覆盖率 >= 80%
3. 检查各模块覆盖率：
   - cardService >= 80%
   - priorityService >= 80%
   - formatters >= 80%
   - branded >= 80%
   - phases >= 70%
4. TypeScript 编译无错误
</verification>

<success_criteria>
- 整体测试覆盖率 >= 80%
- 所有新创建测试文件通过
- 现有测试不被破坏
- 覆盖率报告可查看
- 关键路径 (resolution, services) 覆盖完整
</success_criteria>

<output>
After completion, create `.planning/phases/04-test-coverage/04-05-SUMMARY.md`
</output>
