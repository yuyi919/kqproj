---
phase: 04-test-coverage
plan: 04
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/effect/test-helpers.test.ts
  - src/effect/context/gameStateRef.test.ts
  - src/effect/context/gameRandom.test.ts
autonomous: true
requirements:
  - TEST-02
  - TEST-05
must_haves:
  truths:
    - test-helpers.ts 覆盖率提升至 80%+
    - Effect Context 服务测试完整
    - 所有 Effect 核心组件有测试
  artifacts:
    - path: "src/effect/test-helpers.test.ts"
      provides: "Effect 测试辅助函数测试"
      min_coverage: 80
    - path: "src/effect/context/gameStateRef.test.ts"
      provides: "GameStateRef Context 测试"
      min_coverage: 90
    - path: "src/effect/context/gameRandom.test.ts"
      provides: "GameRandom Context 测试"
      min_coverage: 90
  key_links:
    - from: "src/effect/context/*.test.ts"
      to: "src/effect/context/*.ts"
      via: "import and test"
---

<objective>
为 Effect-TS 测试辅助函数和 Context 服务添加单元测试。

Purpose: 确保 Effect-TS 基础设施稳定可靠
Output: 3 个测试文件，覆盖 test-helpers 和 Context 服务
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-test-coverage/04-CONTEXT.md

## 当前覆盖率状态

- src/effect/test-helpers.ts: 25.00% (严重不足)
- src/effect/context/: 部分文件已有测试

## 参考文件

- src/effect/test-helpers.ts - Effect 测试辅助函数
- src/effect/context/gameStateRef.ts - 游戏状态引用
- src/effect/context/gameRandom.ts - 随机数上下文
- src/effect/context/logger.ts - 日志上下文
- src/effect/layers/gameLayers.ts - Layer 组合

## Effect-TS 测试模式

```typescript
// test-helpers.ts 提供
runSync(effect) - 同步运行 Effect
runSyncExit(effect) - 获取 Exit 结果
expectSuccess(exit) - 验证成功
expectFailure(exit) - 验证失败

// Context 模式
GameStateRef - 可变的游戏状态引用
GameRandom - 随机数生成上下文
Logger - 日志记录上下文
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: 添加 test-helpers 自身测试</name>
  <files>src/effect/test-helpers.test.ts</files>
  <action>
    检查并完善 src/effect/test-helpers.test.ts：

    1. **runSync 测试**:
       - 应成功运行同步 Effect
       - 应正确返回值
       - 失败时应抛出错误

    2. **runSyncExit 测试**:
       - 应返回 Exit.Success 用于成功 Effect
       - 应返回 Exit.Failure 用于失败 Effect

    3. **expectSuccess 测试**:
       - 应从 Exit.Success 提取值
       - 遇到 Exit.Failure 时应抛出错误

    4. **expectFailure 测试** (如果存在):
       - 应从 Exit.Failure 提取错误
       - 遇到 Exit.Success 时应抛出错误

    5. **runPromise 测试** (如果存在):
       - 应异步运行 Effect
       - 应正确处理异步结果

    如果已有 test-helpers.test.ts，确认测试完整；
    如果不完整，补充缺失的测试用例。
  </action>
  <verify>
    bun test src/effect/test-helpers.test.ts --coverage 2>&1 | tail -20
  </verify>
  <done>
    test-helpers.ts 自身测试覆盖主要导出函数
  </done>
</task>

<task type="auto">
  <name>Task 2: 完善 GameStateRef Context 测试</name>
  <files>src/effect/context/gameStateRef.test.ts</files>
  <action>
    检查并完善 src/effect/context/gameStateRef.test.ts：

    1. **layer 创建测试**:
       - 应从初始状态创建 Layer
       - 应正确配置 GameStateRef 服务

    2. **get/set/modify 测试**:
       - get 应返回当前状态
       - set 应更新整个状态
       - modify 应应用状态变换函数

    3. **并发访问测试** (如果适用):
       - 多次读取应返回最新值
       - 写入后读取应看到更新

    4. **边界情况**:
       - 空状态处理
       - 无效状态转换

    如果已有 gameStateRef.test.ts，确认测试完整；
    如果不存在，创建完整测试。
  </action>
  <verify>
    bun test src/effect/context/gameStateRef.test.ts --coverage 2>&1 | tail -20
  </verify>
  <done>
    gameStateRef.ts 所有主要方法有测试
  </done>
</task>

<task type="auto">
  <name>Task 3: 完善 GameRandom Context 测试</name>
  <files>src/effect/context/gameRandom.test.ts</files>
  <action>
    检查并完善 src/effect/context/gameRandom.test.ts：

    1. **layer 创建测试**:
       - 应从 RandomAPI 创建 Layer
       - 应正确配置 GameRandom 服务

    2. **Number 测试**:
       - 应返回 0-1 之间的随机数
       - 使用 mock 时应返回固定值

    3. **Shuffle 测试**:
       - 应打乱数组顺序
       - 使用 mock 时应返回预期顺序

    4. **D4/D6/Die 测试**:
       - 应返回范围内的随机整数
       - 使用 mock 时应返回固定值

    5. **nextInt 测试**:
       - 应在范围内生成整数
       - 边界值测试

    使用 mock RandomAPI 进行确定性测试。
    如果已有 gameRandom.test.ts，确认测试完整；
    如果不存在，创建完整测试。
  </action>
  <verify>
    bun test src/effect/context/gameRandom.test.ts --coverage 2>&1 | tail -20
  </verify>
  <done>
    gameRandom.ts 所有方法有测试
  </done>
</task>

</tasks>

<verification>
1. 运行 `bun test src/effect/` 所有 Effect-TS 相关测试通过
2. 运行 `bun test --coverage` 验证 Effect 目录覆盖率
3. 验证 test-helpers.ts 覆盖率 >= 80%
4. 验证 Context 文件覆盖率 >= 90%
</verification>

<success_criteria>
- test-helpers.ts 覆盖率 >= 80%
- 所有 Context 服务有完整测试
- Effect 核心组件测试覆盖关键路径
- 使用 mock 确保测试确定性
</success_criteria>

<output>
After completion, create `.planning/phases/04-test-coverage/04-04-SUMMARY.md`
</output>
