---
phase: 04-test-coverage
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/message.test.ts
  - src/utils.test.ts
autonomous: true
requirements:
  - TEST-03
  - TEST-04
must_haves:
  truths:
    - message.ts 消息类型和可见性逻辑测试完成
    - utils.ts Selectors 选择器测试覆盖所有方法
    - 消息过滤逻辑测试覆盖所有 kind 类型
  artifacts:
    - path: "src/types/message.test.ts"
      provides: "消息类型和可见性测试"
      min_coverage: 90
    - path: "src/utils.test.ts"
      provides: "Selectors 选择器测试"
      min_coverage: 95
  key_links:
    - from: "src/types/message.test.ts"
      to: "src/types/message.ts"
      via: "import and test"
    - from: "src/utils.test.ts"
      to: "src/utils.ts"
      via: "import and test"
---

<objective>
为消息类型系统和 Selectors 选择器添加全面测试。

Purpose: 确保消息可见性逻辑正确，选择器计算准确
Output: 2 个测试文件，覆盖消息系统和选择器
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-test-coverage/04-CONTEXT.md

## 当前状态

- src/types/ (所有类型定义文件): 100% 覆盖率 (类型定义本身)
- src/utils.ts: 100% 覆盖率 (已有 utils.test.ts)

但需要验证：
1. 消息可见性逻辑是否正确测试
2. Selectors 是否有遗漏的边缘情况

## 参考文件

- src/types/message.ts (消息类型定义)
- src/types/core.ts (核心类型)
- src/utils.ts (Selectors 和 TMessageBuilder)
- src/utils.test.ts (现有测试)
- src/__tests__/visibility.test.ts (消息可见性测试)

## 消息 Kind 和可见性规则

| Kind | Visibility | 描述 |
|------|------------|------|
| announcement | 所有玩家 | 系统公告 |
| public_action | 所有玩家 | 公开行动 |
| private_action | 仅 actor | 私有行动 |
| witnessed_action | actor + target | 见证行动 |

## Selectors 关键方法

- getAlivePlayers(state) - 获取存活玩家
- isPlayerAlive(state, playerId) - 检查玩家存活状态
- getPlayerHandCount(state, playerId) - 获取手牌数量
- computeVoteResult(state) - 计算投票结果
- isGameOver(state) - 检查游戏结束
</context>

<tasks>

<task type="auto">
  <name>Task 1: 添加消息类型和可见性测试</name>
  <files>src/types/message.test.ts</files>
  <action>
    创建 src/types/message.test.ts，测试消息系统和可见性逻辑：

    1. **消息类型测试**:
       - 测试 TMessage 类型创建
       - 测试各 kind 类型: announcement, public_action, private_action, witnessed_action
       - 测试消息字段完整性 (id, kind, type, actorId, targetId 等)

    2. **消息可见性过滤测试**:
       - announcement: 所有玩家可见
       - public_action: 所有玩家可见
       - private_action: 仅 actor 可见
       - witnessed_action: actor 和 target 可见
       - 测试 playerID "0" (调试模式) 可见所有消息

    3. **TMessageBuilder 测试**:
       - createSystem - 创建系统消息
       - createVote - 创建投票消息
       - createPass - 创建跳过消息
       - createUseCard - 创建使用卡牌消息
       - createAttackResult - 创建攻击结果消息
       - createTransformWitch - 创建魔女转化消息
       - createCardReceived - 创建卡牌接收消息

    4. **边界情况测试**:
       - 空消息列表过滤
       - 未知 kind 类型处理
       - 缺少可选字段的消息

    使用 src/__tests__/helpers.ts 中的工厂函数创建测试数据。
  </action>
  <verify>
    bun test src/types/message.test.ts 2>&1 | tail -10
    # 所有测试通过
  </verify>
  <done>
    message.test.ts 存在且所有测试通过，覆盖所有消息 kind 和可见性规则
  </done>
</task>

<task type="auto">
  <name>Task 2: 完善 Selectors 测试</name>
  <files>src/utils.test.ts</files>
  <action>
    检查并完善 src/utils.test.ts，确保所有 Selectors 方法都有测试：

    1. **现有测试确认** (utils.test.ts 已有部分测试):
       - getAlivePlayers ✓
       - isPlayerAlive ✓
       - computeVoteResult ✓

    2. **补充缺失测试**:
       - getPlayerHandCount - 测试正常情况和死亡玩家
       - computeRemainingAttackQuota - 计算剩余攻击配额
       - isGameOver - 各种游戏结束条件
       - getWitchKillerHolder - 获取魔女杀手持有者
       - getVisibleMessages - 消息可见性过滤 (配合 message.test.ts)

    3. **边缘情况测试**:
       - 空游戏状态处理
       - 无效 playerId 处理
       - 边界值: 最大玩家数、空数组
       - 游戏各阶段的状态查询

    4. **TMessageBuilder 集成测试**:
       - 测试创建的消息格式正确
       - 测试消息时间戳生成
       - 测试消息 ID 唯一性

    如果已有 utils.test.ts，则编辑补充；如果已有完整测试，验证覆盖即可。
  </action>
  <verify>
    bun test src/utils.test.ts --coverage 2>&1 | tail -20
    # 验证覆盖率 > 95%
  </verify>
  <done>
    所有 Selectors 方法都有测试，覆盖率 >= 95%
  </done>
</task>

</tasks>

<verification>
1. 运行 `bun test src/types/message.test.ts` 所有测试通过
2. 运行 `bun test src/utils.test.ts` 所有测试通过
3. 运行 `bun test --coverage` 验证消息和选择器相关代码覆盖率
4. 验证消息可见性逻辑覆盖所有 kind 类型
</verification>

<success_criteria>
- message.test.ts 覆盖所有消息 kind 类型
- 消息可见性规则测试完整 (announcement/public/private/witnessed)
- 所有 Selectors 方法有对应测试
- utils.test.ts 覆盖率 >= 95%
- 边缘情况 (空状态、无效ID) 有测试覆盖
</success_criteria>

<output>
After completion, create `.planning/phases/04-test-coverage/04-02-SUMMARY.md`
</output>
