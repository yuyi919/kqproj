---
phase: 04-test-coverage
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/game/phases.test.ts
  - src/game/assertions.test.ts
autonomous: true
requirements:
  - TEST-01
  - TEST-05
must_haves:
  truths:
    - phases.ts 核心相位钩子有单元测试
    - assertions.ts 所有断言函数有单元测试
    - 相位转换逻辑正确性得到验证
  artifacts:
    - path: "src/game/phases.test.ts"
      provides: "相位钩子测试"
      min_coverage: 70
    - path: "src/game/assertions.test.ts"
      provides: "断言函数测试"
      min_coverage: 95
  key_links:
    - from: "src/game/phases.test.ts"
      to: "src/game/phases.ts"
      via: "import and test"
    - from: "src/game/assertions.test.ts"
      to: "src/game/assertions.ts"
      via: "import and test"
---

<objective>
为游戏相位系统和断言函数添加单元测试。

Purpose: 确保相位转换逻辑正确，断言函数按预期工作
Output: 2 个测试文件，覆盖 phase 钩子和 assertions
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-test-coverage/04-CONTEXT.md

## 当前覆盖率状态

- src/game/phases.ts: 60.87% (需要提升)
- src/game/assertions.ts: 88.89% (接近目标，可完善)

## 参考文件

- src/game/phases.ts - 相位配置 (onBegin, onEnd hooks)
- src/game/assertions.ts - 游戏断言函数
- src/game/index.ts - 游戏主定义
- src/__tests__/testUtils.ts - 测试工具
- src/__tests__/game.test.ts - 游戏测试参考

## 相位结构

```typescript
lobby → setup → morning → day → NIGHT → DEEP_NIGHT → resolution → (repeat)
```

## 断言函数

- assertPlayerAlive(G, playerId) - 断言玩家存活
- assertPlayerCanAct(G, playerId) - 断言玩家可行动
- assertCardExists(G, playerId, cardId) - 断言卡牌存在
- assertValidPlayer(G, playerId) - 断言玩家有效
- assertPlayerPublicAlive - 公开视角断言存活
</context>

<tasks>

<task type="auto">
  <name>Task 1: 添加 Assertions 单元测试</name>
  <files>src/game/assertions.test.ts</files>
  <action>
    创建 src/game/assertions.test.ts，测试所有断言函数：

    1. **assertPlayerAlive** 测试:
       - 玩家存活时不抛出错误
       - 玩家死亡时抛出 GameLogicError
       - 玩家不存在时抛出 GameLogicError

    2. **assertPlayerCanAct** 测试:
       - 存活且未被囚禁的玩家可行动
       - 死亡玩家不可行动
       - 被囚禁玩家不可行动

    3. **assertCardExists** 测试:
       - 玩家持有卡牌时通过
       - 玩家未持有卡牌时抛出错误
       - 玩家不存在时抛出错误

    4. **assertValidPlayer** 测试:
       - 存在的玩家通过
       - 不存在的玩家抛出错误
       - 无效 playerID 处理

    5. **assertPlayerPublicAlive** 测试:
       - 从公开视角判断存活 (女巫显示为存活)
       - 已确认死亡玩家抛出错误

    6. **边界情况**:
       - 空游戏状态处理
       - 无效参数类型处理
       - 错误消息内容验证

    使用 expect(() => fn()).toThrow() 模式测试错误抛出。
  </action>
  <verify>
    bun test src/game/assertions.test.ts --coverage 2>&1 | tail -20
    # 验证覆盖率 > 95%
  </verify>
  <done>
    assertions.test.ts 存在且所有测试通过，覆盖率 >= 95%
  </done>
</task>

<task type="auto">
  <name>Task 2: 添加 Phase 钩子测试</name>
  <files>src/game/phases.test.ts</files>
  <action>
    创建 src/game/phases.test.ts，测试相位配置和钩子：

    1. **lobby phase** 测试:
       - onBegin 钩子行为
       - 可用 moves
       - 结束条件

    2. **setup phase** 测试:
       - onBegin 初始化游戏状态
       - 玩家分配
       - 卡牌分发

    3. **morning phase** 测试:
       - onBegin 宣布夜间死亡
       - 死亡消息生成
       - 阶段转换逻辑

    4. **day phase** 测试:
       - onBegin/onEnd 钩子
       - 可用 moves (say, pass, useCard 等)
       - 阶段持续时间

    5. **NIGHT phase** 测试:
       - 投票阶段逻辑
       - votingDuration 应用
       - 投票结束处理

    6. **DEEP_NIGHT phase** 测试:
       - 夜间行动阶段
       - nightDuration 应用
       - 卡牌使用逻辑

    7. **resolution phase** 测试:
       - onBegin 调用 resolution 逻辑
       - 阶段结束后的状态转换

    注意: phases.ts 包含复杂的钩子逻辑，重点测试：
    - onBegin/onEnd 是否被正确调用
    - 状态变更是否正确
    - 阶段转换是否触发

    使用 src/__tests__/testUtils.ts 中的 createSetupContext 和辅助函数。
  </action>
  <verify>
    bun test src/game/phases.test.ts --coverage 2>&1 | tail -20
    # 验证覆盖率 >= 70%
  </verify>
  <done>
    phases.test.ts 存在且所有测试通过，覆盖率 >= 70%
  </done>
</task>

</tasks>

<verification>
1. 运行 `bun test src/game/assertions.test.ts` 所有测试通过
2. 运行 `bun test src/game/phases.test.ts` 所有测试通过
3. 运行 `bun test --coverage` 验证：
   - assertions.ts 覆盖率 >= 95%
   - phases.ts 覆盖率 >= 70%
</verification>

<success_criteria>
- assertions.ts 所有断言函数有测试
- phases.ts 核心钩子有测试覆盖
- 错误抛出场景有测试
- 边界情况有测试
- TypeScript 编译无错误
</success_criteria>

<output>
After completion, create `.planning/phases/04-test-coverage/04-03-SUMMARY.md`
</output>
