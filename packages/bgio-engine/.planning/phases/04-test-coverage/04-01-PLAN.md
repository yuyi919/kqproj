---
phase: 04-test-coverage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/__tests__/helpers.ts
  - src/effect/services/cardService.test.ts
  - src/effect/services/priorityService.test.ts
autonomous: true
requirements:
  - TEST-02
must_haves:
  truths:
    - CardService 测试覆盖率提升至 80%+
    - PriorityService 测试覆盖率提升至 80%+
    - 测试工厂函数封装在 helpers.ts 中
  artifacts:
    - path: "src/__tests__/helpers.ts"
      provides: "通用测试工厂函数"
      contains: ["makeGameState", "makePlayer", "makeCard"]
    - path: "src/effect/services/cardService.test.ts"
      provides: "CardService 单元测试"
      min_coverage: 80
    - path: "src/effect/services/priorityService.test.ts"
      provides: "PriorityService 单元测试"
      min_coverage: 80
  key_links:
    - from: "src/effect/services/cardService.test.ts"
      to: "src/effect/services/cardService.ts"
      via: "import and test"
    - from: "src/effect/services/priorityService.test.ts"
      to: "src/effect/services/priorityService.ts"
      via: "import and test"
---

<objective>
为 Effect-TS 服务层中覆盖率较低的 CardService 和 PriorityService 添加单元测试，并创建通用的测试工厂函数。

Purpose: 提升核心 Effect-TS 服务的测试覆盖率，确保服务逻辑稳定可靠
Output: 3 个测试文件，覆盖率均达到 80%+
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-test-coverage/04-CONTEXT.md

## 当前覆盖率状态

根据 `bun test --coverage` 报告：
- src/effect/services/cardService.ts: 9.09% (严重不足)
- src/effect/services/priorityService.ts: 40.00% (需要提升)
- src/effect/test-helpers.ts: 25.00% (需要完善)

## 参考文件

- src/effect/services/attackResolutionService.test.ts (良好示例)
- src/effect/services/messageService.test.ts
- src/effect/services/playerStateService.test.ts
- src/__tests__/testUtils.ts (现有工厂函数)

## 测试模式

```typescript
// Effect-TS 服务测试模式
function makeLayer(state: BGGameState) {
  return Layer.provideMerge(
    Layer.provideMerge(GameLayers, GameStateRef.layer(state)),
    makeGameRandomLayer(createMockRandom()),
  );
}

function runService<T>(state: BGGameState, effect: Effect.Effect<T>) {
  const program = effect.pipe(Effect.provide(makeLayer(state)));
  return Effect.runSync(program);
}
```
</context>

<tasks>

<task type="auto">
  <name>Task 1: 创建通用测试工厂函数</name>
  <files>src/__tests__/helpers.ts</files>
  <action>
    创建 src/__tests__/helpers.ts 文件，封装以下工厂函数：

    1. `makeGameState(overrides?)` - 创建基础游戏状态
       - 使用 SEVEN_PLAYER_CONFIG 作为默认配置
       - 接受 overrides 参数覆盖特定字段
       - 返回完整的 BGGameState

    2. `makePlayer(id, overrides?)` - 创建玩家对象
       - 创建 public 状态 (status, name 等)
       - 创建 secret 状态 (hand, isWitch 等)

    3. `makeCard(type, id?)` - 创建卡牌对象
       - 支持所有卡牌类型: witch_killer, barrier, kill, detect, check

    4. `makeTestScenario(options)` - 创建完整测试场景
       - playerCount: 玩家数量
       - withWitchKiller: 是否包含魔女杀手持有者
       - withDeadPlayers: 死亡玩家列表
       - 返回配置好的游戏状态

    5. `makeLayerWithState(state)` - 创建 Effect Layer
       - 包装 GameLayers + GameStateRef + GameRandom
       - 返回可直接用于 Effect.provide 的 Layer

    所有工厂函数使用 `make` 前缀，符合 04-CONTEXT.md 中的决策。
  </action>
  <verify>
    bun test src/__tests__/helpers.ts 2>&1 | grep -E "(pass|fail)"
  </verify>
  <done>
    helpers.ts 文件存在，包含所有 5 个工厂函数，TypeScript 类型检查通过
  </done>
</task>

<task type="auto">
  <name>Task 2: 添加 CardService 单元测试</name>
  <files>src/effect/services/cardService.test.ts</files>
  <action>
    创建 src/effect/services/cardService.test.ts，测试 CardService 的所有方法：

    1. **createCard** 测试:
       - 应成功创建各种类型的卡牌
       - 应验证卡牌属性 (id, type, owner)

    2. **dealCard** 测试:
       - 应成功将卡牌发给玩家
       - 应更新玩家的 hand
       - 应处理手牌上限 (maxHandSize)
       - 错误情况：玩家不存在、卡牌不存在

    3. **discardCard** 测试:
       - 应成功弃置玩家手牌
       - 应从 hand 中移除卡牌
       - 错误情况：玩家未持有该卡牌

    4. **transferCard** 测试:
       - 应成功在玩家间转移卡牌
       - 应更新双方的 hand
       - 错误情况：源玩家没有卡牌、目标玩家手牌已满

    5. **shuffleDeck** 测试:
       - 应成功洗牌
       - 应使用 RandomAPI 的 Shuffle 方法

    使用 helpers.ts 中的工厂函数创建测试数据。
    参考 attackResolutionService.test.ts 的测试模式。
  </action>
  <verify>
    bun test src/effect/services/cardService.test.ts --coverage 2>&1 | tail -20
    # 验证覆盖率 > 80%
  </verify>
  <done>
    cardService.test.ts 存在且所有测试通过，覆盖率 >= 80%
  </done>
</task>

<task type="auto">
  <name>Task 3: 添加 PriorityService 单元测试</name>
  <files>src/effect/services/priorityService.test.ts</files>
  <action>
    创建 src/effect/services/priorityService.test.ts，测试 PriorityService：

    1. **calculatePriority** 测试:
       - 应正确计算各类行动优先级
       - witch_killer 优先级最高
       - barrier 次之
       - kill/detect/check 优先级较低

    2. **sortByPriority** 测试:
       - 应按优先级正确排序行动列表
       - 相同优先级时保持原有顺序

    3. **getHighestPriority** 测试:
       - 应返回优先级最高的行动
       - 空列表时返回 null/undefined

    4. **comparePriority** 测试:
       - 应正确比较两个行动的优先级
       - 返回 -1, 0, 1

    5. **resolveConflicts** 测试:
       - 应正确处理优先级冲突
       - 高优先级行动应覆盖低优先级

    使用 helpers.ts 创建测试数据。
  </action>
  <verify>
    bun test src/effect/services/priorityService.test.ts --coverage 2>&1 | tail -20
    # 验证覆盖率 > 80%
  </verify>
  <done>
    priorityService.test.ts 存在且所有测试通过，覆盖率 >= 80%
  </done>
</task>

</tasks>

<verification>
1. 运行 `bun test src/effect/services/` 所有服务测试通过
2. 运行 `bun test --coverage` 验证：
   - cardService.ts 覆盖率 >= 80%
   - priorityService.ts 覆盖率 >= 80%
3. TypeScript 编译无错误：`bun run typecheck`
</verification>

<success_criteria>
- CardService 测试覆盖率 >= 80%
- PriorityService 测试覆盖率 >= 80%
- helpers.ts 工厂函数可被其他测试复用
- 所有测试使用 BDD 风格 (describe/it, "should...")
- 测试数据使用工厂函数创建，避免硬编码
</success_criteria>

<output>
After completion, create `.planning/phases/04-test-coverage/04-01-SUMMARY.md`
</output>
