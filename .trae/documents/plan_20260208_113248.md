# Next.js 16 适配与游戏房间重构计划 (修正版)

根据您的反馈，我们调整了数据库 Schema 设计，使用 Enum 管理状态并标准化时间字段。

## 1. 数据库 Schema 升级

-   **引入枚举类型 (Enums)**:
    -   定义 `enum GameRoomStatus { WAITING PLAYING FINISHED DESTROYED }`。
    -   定义 `enum GamePlayerStatus { JOINED READY LEFT }` (同时优化玩家状态)。
-   **标准化字段**:
    -   **game_rooms**:
        -   `status`: String -> `GameRoomStatus` (新增 `DESTROYED` 状态用于逻辑删除)。
        -   新增 `updated_at DateTime @updatedAt`。
    -   **game_players**:
        -   `joined_at` -> 重命名为 `created_at`。
        -   新增 `updated_at DateTime @updatedAt`。
        -   `status`: String -> `GamePlayerStatus`。

## 2. 后端 API 逻辑更新 (`game.ts`)

-   **逻辑删除**:
    -   **Leave 接口**: 当房间人数降为 0 时，执行 `update({ status: "DESTROYED" })`。
-   **状态校验**:
    -   **Join 接口**: 校验房间状态是否为 `WAITING` (自动排除 `DESTROYED`)。
-   **字段适配**:
    -   更新所有查询和插入操作以匹配新的 `created_at`/`updated_at` 字段名。

## 3. 前端重构 (Next.js 16 架构)

-   **页面拆分**:
    -   **Server Component (`app/room/[id]/page.tsx`)**:
        -   使用 `React.use(params)`。
        -   服务端预取房间数据 (`getRoom`)。
        -   将数据传递给客户端组件。
    -   **Client Component (`components/game/GameRoom/GameRoomClient.tsx`)**:
        -   接收 `initialData`。
        -   处理实时交互与 UI 渲染。
        -   更新字段引用 (`joined_at` -> `created_at`)。

## 执行步骤

1.  修改 `prisma/schema.prisma` 定义 Enums 并调整字段。
2.  更新 `apps/web/src/server/api/routes/game.ts` 适配新 Schema。
3.  新建 `GameRoomClient.tsx` 并迁移/重构 UI 代码。
4.  更新 `page.tsx` 为服务端组件。
