## 目标

利用现有的 Supabase 适配代码，在 Socket.io 服务中集成身份验证和用户信息。

## 技术方案

### 1. 身份验证逻辑复用

我们将复用 `@utils/supabase/constants` 中的配置，并借鉴 `src/server/api/middleware/supabase.ts` 中的客户端创建逻辑。

* **环境适配**: 由于 Socket.io 运行在 Pages Router 的 HTTP Server 层，无法直接使用 App Router 的 `next/headers`。

* **解析 Cookie**: 虽然 Next.js 在 API 路由中提供 `req.cookies`，但在 Socket.io 的 `connection` 生命周期中，我们需要处理原始的 `IncomingMessage`。我们将使用一个符合 Next.js 惯例的轻量级解析器（或利用 `socket.handshake.headers.cookie`）来初始化 Supabase 客户端。

### 2. 身份验证中间件

在 `setupSocketIO` 中增加全局中间件：

* **创建客户端**: 使用 `@supabase/ssr` 的 `createServerClient`。

* **获取用户**: 调用 `supabase.auth.getUser()` 验证当前连接的合法性。

* **存储用户信息**: 将 `user` 及其基本资料（如 `id`, `email`, `username`）存储在 `socket.data.user` 中。

### 3. 业务逻辑对接

* **安全发送**: `message:send` 事件将强制使用 `socket.data.user.id` 作为发送者。

* **资源权限**: 在 `subscribe` 逻辑中，增加对 `socket.data.user` 的校验，确保用户只能订阅有权限查看的资源。

* **实时用户信息**: 广播消息时，附带从 Supabase 获取的用户元数据（如头像、昵称）。

### 4. 优化与类型定义

* 更新 `SocketData` 类型定义，确保护接后的代码具有良好的 TypeScript 支持。

## 待办事项

1. [ ] 在 `src/server/api/socket-io.ts` 中实现基于 Socket 请求头的 Supabase 客户端初始化函数。
2. [ ] 实现 `authMiddleware`并通过 `io.use()` 挂载。
3. [ ] 修改 `message:send` 事件，使其使用认证后的用户 ID。
4. [ ] 更新前端 Hook，确保在连接断开重连时能正确同步身份状态。

是否开始执行？
