# Refactor Authentication with Server-Side Initial Data

This plan addresses the requirement to unify authentication handling using `useAuthUser()`, introduce a `ServerAuthContext`, and leverage server-side data fetching for better performance and best practices (Next.js 16+).

## 1. Create ServerAuthContext
Create a new React Context to store the initial user identity fetched on the server. This will allow the client-side hooks to access the user state immediately without a second round-trip.

- **File**: `apps/web/src/contexts/server-auth.tsx`
- **Content**:
  - `ServerAuthContext`: Context for `IUser | null`.
  - `ServerAuthProvider`: Client component provider.
  - `useServerAuth`: Hook to consume the context.

## 2. Update `useAuthUser` Hook
Modify the existing `useAuthUser` hook to use the `ServerAuthContext` as the `initialData` for the underlying `useGetIdentity` call. This ensures that if the server has already authenticated the user, the client doesn't need to fetch again.

- **File**: `apps/web/src/hooks/use-user.ts`
- **Changes**:
  - Import `useServerAuth`.
  - Pass `initialData: serverUser` to `useGetIdentity`'s `queryOptions`.

## 3. Server-Side Fetching in Layout
Implement the actual server-side data fetching in the root layout. This guarantees that every page load attempts to resolve the user identity on the server first.

- **File**: `apps/web/src/app/layout.tsx`
- **Changes**:
  - Use `authProviderServer.getIdentity()` (or direct Supabase client) to fetch the user.
  - Wrap the application (inside `<Refine>`) with `<ServerAuthProvider initialUser={identity}>`.

## 4. Refactor Components to use `useAuthUser`
Replace all direct usages of `useGetIdentity` with the standardized `useAuthUser` hook.

- **Files**:
  - `apps/web/src/components/game/GameRoom/GameRoomClient.tsx`
  - `apps/web/src/app/lobby/page.tsx`
  - `apps/web/src/components/chat/index.tsx`

## Verification
- Ensure the application builds successfully.
- Verify that user data is available immediately on page load (no flickering).
- Verify that `useAuthUser` returns the correct user object.
