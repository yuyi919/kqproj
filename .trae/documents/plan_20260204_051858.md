## 重构 Supabase 相关逻辑计划

### 1. 抽象通用逻辑到 `SupabaseHost` 类

在 `src/utils/supabase/host.ts` 中创建 `SupabaseHost` 类。该类将封装常用的 Supabase 操作，减少代码重复。

* **构造函数**：接收一个 `SupabaseClient` 实例。

* **核心方法**：

  * `getUser()`: 封装 `auth.getUser()`。

  * `getProfile(userId: string)`: 从 `users` 表获取用户信息。

  * `getIdentity()`: 整合 `user` 和 `profile` 数据，返回符合 `IUser` 接口的对象（用于 Refine 的身份识别）。

### 2. 统一通用代码到 `utils/supabase` 目录

* **新建** **`src/utils/supabase/utils.ts`**：

  * 迁移 `parseCookies` 函数（目前在 `socket-io.ts` 中重复定义），供 Socket.io 和其他非标准环境使用。

* **整理** **`src/utils/supabase/index.ts`**（如果需要）：导出所有常用的 Supabase 工具和类。

### 3. 应用重构到现有模块

* **`src/server/api/socket-io.ts`**：

  * 使用 `src/utils/supabase/utils.ts` 中的 `parseCookies`。

  * 在身份验证中间件中使用 `SupabaseHost` 来处理用户信息获取逻辑。

* **`src/providers/auth-provider/public.ts`**：

  * 使用 `SupabaseHost` 重构 `getIdentity` 和 `check` 方法，简化代码结构。

* **`src/server/api/middleware/supabase.ts`** (Hono 中间件)：

  * 考虑在 Hono 上下文中同时提供 `supabase` 客户端和 `SupabaseHost` 实例。

### 4. 验证与清理

* 确保所有引用 `createServerClient` 的地方依然能够正常工作。

* 检查类型定义是否一致，特别是 `IUser` 和 `SupabaseUser` 的转换。

* 删除各处重复定义的工具函数（如 `parseCookies`）。

是否可以开始实施？
