<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>@ws-kit/bun Chat Demo</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      width: 100%;
      max-width: 600px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
      height: 90vh;
      max-height: 600px;
    }

    .header {
      padding: 20px;
      border-bottom: 1px solid #eee;
      background: #f8f9fa;
    }

    .header h1 {
      font-size: 20px;
      margin-bottom: 10px;
    }

    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }

    button {
      padding: 8px 16px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }

    button:hover {
      background: #5568d3;
    }

    .status {
      font-size: 12px;
      color: #666;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .message {
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 14px;
      word-break: break-word;
    }

    .message.system {
      background: #f0f0f0;
      color: #666;
      font-style: italic;
    }

    .message.user {
      background: #667eea;
      color: white;
      margin-left: auto;
      max-width: 80%;
    }

    .message.other {
      background: #e9ecef;
      color: #333;
      max-width: 80%;
    }

    .message.user-meta {
      font-size: 12px;
      margin: 5px 0;
      opacity: 0.8;
    }

    .input-area {
      padding: 20px;
      border-top: 1px solid #eee;
      display: flex;
      gap: 10px;
    }

    #messageInput {
      flex: 1;
    }

    #sendBtn {
      padding: 8px 24px;
    }

    .info {
      font-size: 12px;
      color: #999;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üí¨ WebSocket Chat</h1>
      <div class="controls">
        <input id="roomInput" type="text" placeholder="Room name" value="general">
        <button id="joinBtn">Join Room</button>
      </div>
      <div class="status">
        <span id="statusText">Connecting...</span>
      </div>
    </div>

    <div class="messages" id="messages"></div>

    <div class="input-area">
      <input id="messageInput" type="text" placeholder="Type a message..." disabled>
      <button id="sendBtn" disabled>Send</button>
    </div>

    <div class="info" id="info"></div>
  </div>

  <script>
    let ws = null;
    let currentRoom = null;

    const elements = {
      roomInput: document.getElementById('roomInput'),
      joinBtn: document.getElementById('joinBtn'),
      messageInput: document.getElementById('messageInput'),
      sendBtn: document.getElementById('sendBtn'),
      messages: document.getElementById('messages'),
      statusText: document.getElementById('statusText'),
      info: document.getElementById('info'),
    };

    function connect() {
      const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${location.host}/ws`);

      ws.onopen = () => {
        elements.statusText.textContent = '‚úÖ Connected';
        elements.joinBtn.disabled = false;
      };

      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        const p = msg.payload || {};

        switch (msg.type) {
          case 'SERVER:WELCOME':
            addSystemMessage(`Welcome! Your ID: ${p.clientId.slice(0, 8)}`);
            elements.info.textContent = `Client ID: ${p.clientId.slice(0, 8)}`;
            break;

          case 'ROOM:USERS':
            addSystemMessage(`Room '${p.room}' has ${p.count} user(s)`);
            break;

          case 'USER:JOINED':
            addSystemMessage(`‚Üí ${p.user} joined the room`);
            break;

          case 'USER:LEFT':
            addSystemMessage(`‚Üê ${p.user} left the room`);
            break;

          case 'MESSAGE:BROADCAST':
            addMessage(p.user, p.text);
            break;

          case 'SERVER:ERROR':
            addSystemMessage(`‚ö†Ô∏è Error: ${p.message}`);
            break;
        }
      };

      ws.onclose = () => {
        elements.statusText.textContent = '‚ùå Disconnected';
        elements.joinBtn.disabled = true;
        elements.messageInput.disabled = true;
        elements.sendBtn.disabled = true;
        setTimeout(connect, 3000);
      };

      ws.onerror = () => {
        elements.statusText.textContent = '‚ö†Ô∏è Connection error';
      };
    }

    function addMessage(user, text) {
      const div = document.createElement('div');
      const isOwn = text.startsWith('[YOU]');

      div.className = 'message ' + (isOwn ? 'user' : 'other');
      div.innerHTML = `
        <div class="user-meta">${user}</div>
        <div>${text}</div>
      `;

      elements.messages.appendChild(div);
      elements.messages.scrollTop = elements.messages.scrollHeight;
    }

    function addSystemMessage(text) {
      const div = document.createElement('div');
      div.className = 'message system';
      div.textContent = text;
      elements.messages.appendChild(div);
      elements.messages.scrollTop = elements.messages.scrollHeight;
    }

    elements.joinBtn.onclick = () => {
      const room = elements.roomInput.value.trim();
      if (!room) return;

      currentRoom = room;
      ws.send(JSON.stringify({
        type: 'ROOM:JOIN',
        payload: { room },
      }));

      elements.messageInput.disabled = false;
      elements.sendBtn.disabled = false;
      elements.messageInput.focus();
    };

    elements.sendBtn.onclick = () => {
      const text = elements.messageInput.value.trim();
      if (!text) return;

      ws.send(JSON.stringify({
        type: 'MESSAGE:SEND',
        payload: { text },
      }));

      addMessage('[YOU]', text);
      elements.messageInput.value = '';
      elements.messageInput.focus();
    };

    elements.messageInput.onkeydown = (e) => {
      if (e.key === 'Enter') elements.sendBtn.click();
    };

    // Start connection
    connect();
  </script>
</body>
</html>